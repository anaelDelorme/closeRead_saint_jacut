{
  "hash": "9445377ba4f499be2d086f3e12e1c4af",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"OJS Maps\"\n# image: \"globe.png\"\nsubtitle: \"Animate a Mapbox or MapLibre map.\"\nformat:\n  closeread-html:\n    code-tools: true\n    cr-style:\n      narrative-background-color-overlay: \"#708090dd\"\n      narrative-text-color-overlay: white\n      narrative-background-color-sidebar: transparent\n      section-background-color: transparent\n    css:\n      - https://cdn.jsdelivr.net/npm/maplibre-gl@4.7.1/dist/maplibre-gl.css\n---\n\n\n\n\nIf you've seen the [OJS Basics](/gallery/demos/ojs-basics/index.qmd) demo, you've seen ways that we can use scroll progress to make graphics that \"animate\" as the user scrolls.\n\nThat demo completely destroys and recreates the graphic continuously as the user scrolls, which works well for Observable Plot.\n\nBut many other JavaScript frameworks have animation capabilities built in, and if you want to leverage those capabilities, you may not be able to use this technique - any potential animation in them is lost the moment you destroy it.\n\nIn these cases, we initialise the map in one chunk of OJS code, then write the reactive bit — the part that ties it to our scroll progress — in a separate chunk.\n\n# Bertin.js\n\n[Bertin.js](https://github.com/riatelab/bertin) is a simple mapping library. You can absolutely use it as we do in the [OJS Basics](/gallery/demos/ojs-basics/index.qmd) demo, replacing the map wholesale. But you can also use its `update()` function to change it \n\n\n\n\n```{ojs}\ncities = [\n  { name: \"Brisbane\",  lat: -27.467778, lon: 153.028056 },\n  { name: \"New Delhi\", lat: 28.613889,  lon: 77.208889 },\n  { name: \"Singapore\", lat: 1.283333,   lon: 103.833333 },\n  { name: \"Istanbul\",  lat: 41.013611,  lon: 28.955 },\n  { name: \"Paris\",     lat: 48.856667,  lon: 2.352222 },\n  { name: \"Nairobi\",   lat: -1.286389,  lon: 36.817222 },\n  { name: \"São Paulo\", lat: -23.55,     lon: -46.633333 },\n  { name: \"Montreal\",  lat: 45.508889,  lon: -73.554167 },\n  { name: \"Houston\",   lat: 29.762778,  lon: -95.383056 },\n  { name: \"Vancouver\", lat: 49.260833,  lon: -123.113889 },\n  { name: \"Honolulu\",  lat: 21.306944,  lom: -157.858333 }\n]\n\nworld = FileAttachment(\"naturalearth-land-110m.geojson\").json()\n\n// add a population column and convert to geojson\ncitiesGeo = bertin.table2geo(cities.map(d => ({...d, size: 3})))\n\nbertin = require(\"bertin@1.8\")\n```\n\n\n\n\n::::{.cr-section}\n\nFirst, let's draw the map. Let's mark the cities from the [OJS Basics](/gallery/demos/ojs-basics/index.qmd) demo too. @cr-bertin\n\n:::{#cr-bertin}\n\n\n\n```{ojs}\nbertinMap = bertin.draw({\n  params: { projection: d3.geoNaturalEarth1() },\n  layers: [\n    {\n      id: \"city-layer\",\n      type: \"bubble\",\n      geojson: citiesGeo,\n      values: \"size\",\n      k: 20,\n      fill: \"orangered\",\n\n      tooltip: [ \"$name\" ]\n    },\n    {\n      type: \"layer\",\n      geojson: world,\n      fill: \"#f5d482\"\n    },\n    { type: \"graticule\" },\n    { type: \"outline\" }\n  ]\n})\n```\n\n\n\n:::\n\n:::{focus-on=\"cr-bertin\"}\nNow we can update aspects of the map:\n\n\n\n\n```{ojs}\n// echo: true\nnewMap = {\n  const scrollColour = crTriggerIndex >= 1 ?\n    \"royalblue\" : \"orangered\"\n\n  bertinMap.update({\n    id: \"city-layer\",\n    attr: \"fill\",\n    value: scrollColour,\n    duration: 1000\n  })\n}\n```\n\n\n\n:::\n\nNotice that the map transitions between states instead of being replaced! @cr-bertin\n\n::::\n\nNice! Let's see if we can apply this to a slightly more complex example.\n\n\n# Leaflet\n\n\n::::{.cr-section}\n\nFirst, let's draw the map. Let's mark the cities from the [OJS Basics](/gallery/demos/ojs-basics/index.qmd) demo too. @cr-leaflet\n\n:::{#cr-leaflet}\n\n```{{r}}\n\nlibrary(leaflet)\nleaflet() %>%\n  addTiles() %>%  # Add default OpenStreetMap map tiles\n  addMarkers(lng=174.768, lat=-36.852, popup=\"The birthplace of R\")\n  \n```\n\n\n\n\n::: {.cell}\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: le package 'tidyverse' a été compilé avec la version R 4.2.3\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: le package 'tibble' a été compilé avec la version R 4.2.3\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: le package 'forcats' a été compilé avec la version R 4.2.3\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr}\n\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.4     ✔ readr     2.1.5\n✔ forcats   1.0.0     ✔ stringr   1.5.1\n✔ ggplot2   3.5.1     ✔ tibble    3.2.1\n✔ lubridate 1.9.3     ✔ tidyr     1.3.1\n✔ purrr     1.0.2     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n\n\n:::\n\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"leaflet html-widget html-fill-item\" id=\"htmlwidget-6c6119993049953844e8\" style=\"width:100%;height:464px;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-6c6119993049953844e8\">{\"x\":{\"options\":{\"crs\":{\"crsClass\":\"L.CRS.EPSG3857\",\"code\":null,\"proj4def\":null,\"projectedBounds\":null,\"options\":{}}},\"calls\":[{\"method\":\"addTiles\",\"args\":[\"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\",null,null,{\"minZoom\":0,\"maxZoom\":18,\"tileSize\":256,\"subdomains\":\"abc\",\"errorTileUrl\":\"\",\"tms\":false,\"noWrap\":false,\"zoomOffset\":0,\"zoomReverse\":false,\"opacity\":1,\"zIndex\":1,\"detectRetina\":false,\"attribution\":\"&copy; <a href=\\\"https://openstreetmap.org/copyright/\\\">OpenStreetMap<\\/a>,  <a href=\\\"https://opendatacommons.org/licenses/odbl/\\\">ODbL<\\/a>\"}]},{\"method\":\"addMarkers\",\"args\":[-36.852,174.768,null,null,null,{\"interactive\":true,\"draggable\":false,\"keyboard\":true,\"title\":\"\",\"alt\":\"\",\"zIndexOffset\":0,\"opacity\":1,\"riseOnHover\":false,\"riseOffset\":250},\"The birthplace of R\",null,null,null,null,{\"interactive\":false,\"permanent\":false,\"direction\":\"auto\",\"opacity\":1,\"offset\":[0,0],\"textsize\":\"10px\",\"textOnly\":false,\"className\":\"\",\"sticky\":true},null]}],\"limits\":{\"lat\":[-36.852,-36.852],\"lng\":[174.768,174.768]}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\n\n\n:::\n\n:::{focus-on=\"cr-leaflet\"}\n\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n\n```{=html}\n<div class=\"leaflet html-widget html-fill-item\" id=\"htmlwidget-618a595ce5908b2ad4c1\" style=\"width:100%;height:464px;\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-618a595ce5908b2ad4c1\">{\"x\":{\"options\":{\"crs\":{\"crsClass\":\"L.CRS.EPSG3857\",\"code\":null,\"proj4def\":null,\"projectedBounds\":null,\"options\":{}}},\"calls\":[{\"method\":\"addTiles\",\"args\":[\"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\",null,null,{\"minZoom\":0,\"maxZoom\":18,\"tileSize\":256,\"subdomains\":\"abc\",\"errorTileUrl\":\"\",\"tms\":false,\"noWrap\":false,\"zoomOffset\":0,\"zoomReverse\":false,\"opacity\":1,\"zIndex\":1,\"detectRetina\":false,\"attribution\":\"&copy; <a href=\\\"https://openstreetmap.org/copyright/\\\">OpenStreetMap<\\/a>,  <a href=\\\"https://opendatacommons.org/licenses/odbl/\\\">ODbL<\\/a>\"}]},{\"method\":\"addMarkers\",\"args\":[-36.852,174.768,null,null,null,{\"interactive\":true,\"draggable\":false,\"keyboard\":true,\"title\":\"\",\"alt\":\"\",\"zIndexOffset\":0,\"opacity\":1,\"riseOnHover\":false,\"riseOffset\":250},\"The birthplace of R\",null,null,null,null,{\"interactive\":false,\"permanent\":false,\"direction\":\"auto\",\"opacity\":1,\"offset\":[0,0],\"textsize\":\"10px\",\"textOnly\":false,\"className\":\"\",\"sticky\":true},null]},{\"method\":\"addPopups\",\"args\":[-36,175,\"Here is the <b>Department of Statistics<\\/b>, ISU\",null,null,{\"maxWidth\":300,\"minWidth\":50,\"autoPan\":true,\"keepInView\":false,\"closeButton\":true,\"className\":\"\"}]}],\"limits\":{\"lat\":[-36.852,-36],\"lng\":[174.768,175]}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n\n:::\n:::\n\n\n\n\n:::\n\nEssai @cr-leaflet\n\n::::\n\n\n\n\n\n# MapLibre\n\nLet's try the technique out with [MapLibre](https://maplibre.org), an open fork of [Mapbox GL JS](https://docs.mapbox.com/mapbox-gl-js/guides/).\n\n:::{.column-margin}\nThis pattern will work just as well with Mapbox, as well as with most frameworks that let you call separate code to 'update' their graphics.\n:::\n\nMapLibre doesn't require an API key the way Mapbox does, but it also doesn't come with any tiles out of the box.\n\n\n\n\n```{ojs}\nr = require.alias({\n  maplibregl: \"maplibre-gl@2.1.9/dist/maplibre-gl.js\",\n  h3: {},\n  // deck: \"deck.gl@8.9.35/dist.min.js\"\n})\n\nmaplibregl = r(\"maplibregl\").catch(() => window[\"maplibregl\"])\n```\n\n\n\n\nToday we'll use some [demo tiles](https://github.com/maplibre/demotiles) that MapLibre provides — they're great for global or continental scale maps, but if you need to show more fine-grained stuff like streets, you might need to make your own tiles or look for a commercial service.\n\n::::{.cr-section layout=\"overlay-left\"}\n\n:::{focus-on=\"cr-maplibre\"}\nFirstly, we'll initialise our map. This has three steps:\n\n1. Create a container for it\n2. Initialise the map itself\n3. When the map is ready, connect it back to OJS. This lets us [use the map as an input](https://observablehq.com/@observablehq/a-brief-introduction-to-viewof) if we want to do that\n:::\n\n:::{#cr-maplibre}\n\n\n\n```{ojs}\nviewof scrollMap = {\n  \n  // set the space up for the map\n  // (note that you must currently manually size a full-bleed map!)\n  let container = html`<div style=\"height: 100vh; width: 100vw;\"></div>`\n  \n  /* you can also create an element for the map to appear where you\n     initialise it. this also requires some extra fiddling with size */\n  // let container = document.getElementById(\"cr-maplibre\")\n  \n  yield container\n  \n  // set the map up\n  let map = new maplibregl.Map({\n    container,\n    bounds: [[-175, -80], [175, 85]],\n    pitch: 30,\n    antialias: true,\n    style: \"style.json\",\n    interactive: false\n  })\n\n  map.on(\"load\", () => {\n    container.value = map\n    container.dispatchEvent(new CustomEvent(\"input\"))\n\n    // if your map has layers, create them separately and\n    // call `map.addLayer()` here!\n  })\n\n}\n```\n\n\n\n:::\n\n:::{focus-on=\"cr-maplibre\"}\nNow that the map is ready, we can start to change it!\n\n\n\n\n```{ojs}\n//| echo: true\ntour = {\n  switch (crTriggerIndex) {\n    case 5:\n      scrollMap.flyTo({\n        // se australia\n        center: [147, -35],\n        zoom: 4\n      })\n      break\n    case 6:\n      scrollMap.flyTo({\n        // western usa\n        center: [-120, 42],\n        zoom: 4\n      })\n      break\n    default:\n      scrollMap.flyTo({\n        bounds: [[-175, -80], [175, 85]]\n      })\n  }\n}\n```\n\n\n\n:::\n\nLet's move the map to south-eastern Australia. @cr-maplibre\n\nAnd then to the west coast of the US! @cr-maplibre\n\nWe can modify any of the [map's methods](https://maplibre.org/maplibre-gl-js/docs/API/classes/Map/#methods) — or even update a layer on the map, like filtering it or changing its colours.  @cr-maplibre\n\n::::\n\n<!-- display our ojs variables in the corner -->\n:::{.counter style=\"position: fixed; top: 10px; right: 10px; background-color: skyblue; border-radius: 5px; padding: 18px 18px 0 18px; line-height: .8em; z-index: 9999\"}\n\n\n\n```{ojs}\nmd`Active sticky: ${crActiveSticky}`\nmd`Active trigger: ${crTriggerIndex}`\nmd`Trigger progress: ${(crTriggerProgress * 100).toFixed(1)}%`\nmd`Scroll direction: ${crDirection}`\nmd`Progress Block progress: ${(crProgressBlock * 100).toFixed(1)}%`\n```\n\n\n\n:::\n\n\n\n\n```{=html}\n<!-- blur the narrative backgrounds a bit for readability -->\n<style>\n.narrative {\n  backdrop-filter: blur(10px)\n}\n</style>\n```",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"site_libs/htmltools-fill-0.5.8.1/fill.css\" rel=\"stylesheet\" />\n<script src=\"site_libs/htmlwidgets-1.6.4/htmlwidgets.js\"></script>\n<script src=\"site_libs/jquery-3.6.0/jquery-3.6.0.min.js\"></script>\n<link href=\"site_libs/leaflet-1.3.1/leaflet.css\" rel=\"stylesheet\" />\n<script src=\"site_libs/leaflet-1.3.1/leaflet.js\"></script>\n<link href=\"site_libs/leafletfix-1.0.0/leafletfix.css\" rel=\"stylesheet\" />\n<script src=\"site_libs/proj4-2.6.2/proj4.min.js\"></script>\n<script src=\"site_libs/Proj4Leaflet-1.0.1/proj4leaflet.js\"></script>\n<link href=\"site_libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css\" rel=\"stylesheet\" />\n<script src=\"site_libs/leaflet-binding-2.2.2/leaflet.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}